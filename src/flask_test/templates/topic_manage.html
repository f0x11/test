<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>管理</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script type="text/javascript" src="http://www.shitouren.com/homepage/js/jquery.min.js"></script>
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/flatly/bootstrap.min.css">-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="/static/js/underscore-min.js"></script>
    <script src="/static/js/jquery.ui.widget.js"></script>
    <script src="/static/js/jquery.fileupload.js"></script>
    <style>
        .container {
            max-width: 970px;
        }
    </style>
    <script>
        $(function () {
            $("body").on("click", ".show-img", function (e) {
                e.preventDefault();

                var indexImg = $(this).closest(".panel-body").find(".index-img");
                indexImg.attr("src", indexImg.data('src')).show();

                $(this).hide();
            });

            var begin = 0;
            var limit = 20;
            var fetching = false;
            var normalTopicTemplate = _.template($("#topic-manage-template").html());

            function renderNormalTopic() {
                if (fetching) {
                    return;
                }
                fetching = true;

                var normalTopicUrl = '/api/topic/list';
                var normalTopicData = {
                    postData: JSON.stringify({
                        idx: 0,
                        params: {
                            begin: begin,
                            limit: limit,
                            provid: 1
                        }
                    })
                };

                $.ajax({
                    url: normalTopicUrl,
                    type: 'post',
                    dataType: 'json',
                    data: normalTopicData,
                    success: function (res) {
                        if (res.ret == 0) {
                            var topicElem = $(".show-container");
                            if (begin == 0) {
                                topicElem.empty();
                            }
                            $.each(res.res, function (idx, normalTopic) {
                                console.log(normalTopic)
                                topicElem.append(normalTopicTemplate(normalTopic));
                            });
                            begin += limit;
                        }
                    },
                    error: function (res) {
                        console.log(res.msg)
                    },
                    complete: function () {
                        fetching = false;
                    }
                });
            }

            renderNormalTopic();

            // Change this to the location of your server-side upload handler:
            var url = '/upload';
            $('#fileupload').fileupload({
                url: url,
                dataType: 'json',
                done: function (e, data) {
                    $.each(data.result.files, function (index, file) {
                        $('<p/>').text(file.name).appendTo('#files');
                    });
                },
                progressall: function (e, data) {
                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    $('#progress .progress-bar').css(
                            'width',
                            progress + '%'
                    );
                }
            }).prop('disabled', !$.support.fileInput)
                    .parent().addClass($.support.fileInput ? undefined : 'disabled');
            $('#fileupload').bind('fileuploadsubmit', function (e, data) {
                // The example input, doesn't have to be part of the upload form:
                var input = $('#new-topic-title');
                data.formData = {
                    title: input.val()
                };
//                if (!data.formData.example) {
//                  input.focus();
//                  return false;
//                }
            });
        });
    </script>
</head>
<body>
<header class="navbar navbar-default navbar-static-top" id="top">
    <div class="container">
        <div class="navbar-header">
            <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#bs-navbar"
                    aria-controls="bs-navbar" aria-expanded="false">
                <span class="sr-only">展开/收起</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">石头人</a>
        </div>
        <nav id="bs-navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a href="../topic_manage.html">话题</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#">好帅的程序员</a>
                </li>
            </ul>
        </nav>
    </div>
</header>
<div class="container">
    <div class="panel panel-default">
        <div class="panel-heading">新话题</div>
        <div class="panel-body">
            <div class="new-topic">
                <div class="form-group">
                    <label for="new-topic-location">省市：</label>
                    <select id="new-topic-location" class="form-control">
                        <option>北京</option>
                        <option>上海</option>
                        <option>江苏</option>
                        <option>江西</option>
                        <option>浙江</option>
                        <option>广西</option>
                        <option>天津</option>
                        <option>广东</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-topic-title">标题：</label>
                    <input id="new-topic-title" type="text" class="form-control" placeholder="请输入标题">
                </div>
                <div class="form-group">
                    <label for="new-topic-content">描述：</label>
                    <textarea id="new-topic-content" class="form-control" placeholder="请输入内容"></textarea>
                </div>
                <div class="has-success">
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" id="new-topic-hot">
                            加入精选
                        </label>
                    </div>
                </div>
                <span class="btn btn-success fileinput-button">
                    <i class="glyphicon glyphicon-plus"></i>
                    <span>Select files...</span>
                    <!-- The file input field used as target for the file upload widget -->
                    <input id="fileupload" type="file" name="files[]" multiple>
                </span>
                <!-- The global progress bar -->
                <div id="progress" class="progress">
                    <div class="progress-bar progress-bar-success"></div>
                </div>
                <!-- The container for the uploaded files -->
                <div id="files" class="files"></div>
            </div>
        </div>
    </div>
</div>
<div class="container show-container">

</div>

<script type="text/template" id="topic-manage-template">
    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title"><%- title %></h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-8">id：<%- topicid %></div>
                <div class="col-md-4"><%- channel %></div>
            </div>
            <div>
                <%- summary %>
            </div>
            <div>
                <a href="#" class="show-img">显示图片</a>
            </div>
            <div>
                <img class="index-img" style="display: none" data-src="<%- imglink %>">
            </div>
            <div>
                状态: <span class="status"><span class="text-success"><%- hot %></span></span>
            </div>
        </div>
        <div class="panel-footer">
            <a href="#" class="toggle-hot">加入/取消精选</a>
        </div>
    </div>
</script>
</body>
</html>
